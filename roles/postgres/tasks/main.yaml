---
- name: Install postgresql-common for repository setup
  ansible.builtin.apt:
    name: postgresql-common
    state: present
    update_cache: true
  become: true

- name: Run PostgreSQL official repository setup script
  ansible.builtin.shell:
    cmd: /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh -y
    # This check prevents the script from running every time
    creates: /etc/apt/sources.list.d/pgdg.list
  become: true

- name: Update apt cache after adding repository
  ansible.builtin.apt:
    update_cache: true
  become: true

- name: Install PostgreSQL {{ postgres_version }}
  ansible.builtin.apt:
    name:
      - "postgresql-{{ postgres_version }}"
      - "postgresql-client-{{ postgres_version }}"
      - "libpq-dev"
    state: present
  become: true

- name: Ensure PostgreSQL service is started and enabled
  ansible.builtin.systemd:
    name: postgresql
    state: started
    enabled: true
  become: true
