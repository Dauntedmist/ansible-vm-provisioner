---
- name: Install SELinux dependencies and management tools
  ansible.builtin.apt:
    name:
      - selinux-basics
      - selinux-policy-default
      - policycoreutils
      - python3-selinux  # Required for Ansible's selinux modules
    state: present
    update_cache: true
  become: true

- name: Configure SELinux mode
  ansible.builtin.selinux:
    policy: "{{ security_selinux_policy }}"
    state: "{{ security_selinux_mode }}"
  become: true
  register: selinux_config

- name: Update GRUB and reboot if SELinux state changed
  ansible.builtin.debug:
    msg: "System may require a reboot to fully apply SELinux changes."
  when: selinux_config.reboot_required

- name: Ensure custom service directories have correct context
  community.general.sefcontext:
    target: "/opt/my-custom-service(/.*)?"
    setype: bin_t
    state: present
  become: true
  # This ensures your dedicated service users can execute their binaries
